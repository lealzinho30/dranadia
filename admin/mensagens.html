<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mensagens - Painel Administrativo</title>
    <link rel="stylesheet" href="admin.css">
    <style>
        :root {
            --primary-color: #2da7ba;
            --primary-dark: #238a9a;
            --secondary-color: #f19022;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="admin-sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-admin">
                    <i class="fas fa-tooth"></i>
                    <span>Admin</span>
                </div>
            </div>
            
            <nav class="sidebar-menu">
                <a href="dashboard.html" class="menu-item">
                    <i class="fas fa-home"></i>
                    Dashboard
                </a>
                <a href="mensagens.html" class="menu-item active">
                    <i class="fas fa-envelope"></i>
                    Mensagens
                    <span id="unreadBadge" class="badge badge-danger" style="float: right; margin-top: 2px;"></span>
                </a>
                <a href="conteudo.html" class="menu-item">
                    <i class="fas fa-edit"></i>
                    Conteúdo
                </a>
                <a href="config.html" class="menu-item">
                    <i class="fas fa-cog"></i>
                    Configurações
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Administrador</div>
                        <div class="user-status" id="userInfo">Online</div>
                    </div>
                </div>
                <button class="btn-logout" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    Sair
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <header class="admin-header">
                <div class="header-left">
                    <button class="menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="header-title">Mensagens</h1>
                </div>
                <div class="header-right">
                    <button class="btn btn-secondary btn-sm" onclick="markAllAsRead()">
                        <i class="fas fa-check-double"></i>
                        Marcar Todas como Lidas
                    </button>
                    <a href="../index.html" target="_blank" class="btn btn-secondary btn-sm">
                        <i class="fas fa-external-link-alt"></i>
                        Ver Site
                    </a>
                </div>
            </header>

            <div class="admin-content">
                <div class="page-header">
                    <h2 class="page-title">Mensagens de Contato</h2>
                    <p class="page-subtitle">Gerencie todas as mensagens recebidas pelo formulário</p>
                </div>

                <div class="content-card">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>E-mail</th>
                                    <th>Telefone</th>
                                    <th>Mensagem</th>
                                    <th>Data</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="messagesTable">
                                <!-- Será preenchido via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal de Detalhes -->
    <div id="messageModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 2rem; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="font-size: 1.5rem; font-weight: 700;">Detalhes da Mensagem</h3>
                <button onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--gray);">&times;</button>
            </div>
            <div id="modalContent"></div>
            <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                <button onclick="closeModal()" class="btn btn-secondary">Fechar</button>
            </div>
        </div>
    </div>

    <script src="auth.js"></script>
    <script src="admin.js"></script>
    <script>
        // Verificar autenticação
        if (!auth.isAuthenticated()) {
            window.location.href = 'index.html';
        }

        // Carregar mensagens
        function loadMessages() {
            const messages = adminFunctions.loadMessages();
            const unreadCount = adminFunctions.getUnreadCount();

            // Atualizar badge
            const unreadBadge = document.getElementById('unreadBadge');
            if (unreadCount > 0) {
                unreadBadge.textContent = unreadCount;
                unreadBadge.style.display = 'inline-block';
            } else {
                unreadBadge.style.display = 'none';
            }

            // Renderizar tabela
            const messagesTable = document.getElementById('messagesTable');
            if (messages.length === 0) {
                messagesTable.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center" style="padding: 3rem;">
                            <div class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <p>Nenhuma mensagem ainda</p>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                messagesTable.innerHTML = messages.map(msg => `
                    <tr style="${!msg.read ? 'background: rgba(45, 167, 186, 0.05);' : ''}">
                        <td><strong>${msg.nome}</strong></td>
                        <td>${msg.email}</td>
                        <td>${msg.telefone}</td>
                        <td>
                            <span style="display: block; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${msg.mensagem}
                            </span>
                        </td>
                        <td>${adminFunctions.formatDate(msg.date)}</td>
                        <td>
                            <span class="badge ${msg.read ? 'badge-success' : 'badge-warning'}">
                                ${msg.read ? 'Lida' : 'Não lida'}
                            </span>
                        </td>
                        <td>
                            <button onclick="viewMessage(${msg.id})" class="btn btn-primary btn-sm">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="deleteMessage(${msg.id})" class="btn btn-danger btn-sm">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        // Ver mensagem
        function viewMessage(id) {
            const messages = adminFunctions.loadMessages();
            const message = messages.find(m => m.id === id);
            
            if (message) {
                // Marcar como lida
                if (!message.read) {
                    adminFunctions.markAsRead(id);
                }

                // Mostrar modal
                document.getElementById('modalContent').innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Nome</label>
                        <div style="padding: 0.75rem; background: var(--light-gray); border-radius: 8px;">
                            ${message.nome}
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">E-mail</label>
                        <div style="padding: 0.75rem; background: var(--light-gray); border-radius: 8px;">
                            <a href="mailto:${message.email}">${message.email}</a>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Telefone</label>
                        <div style="padding: 0.75rem; background: var(--light-gray); border-radius: 8px;">
                            <a href="tel:${message.telefone}">${message.telefone}</a>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Mensagem</label>
                        <div style="padding: 0.75rem; background: var(--light-gray); border-radius: 8px; min-height: 100px;">
                            ${message.mensagem}
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data</label>
                        <div style="padding: 0.75rem; background: var(--light-gray); border-radius: 8px;">
                            ${adminFunctions.formatDate(message.date)}
                        </div>
                    </div>
                `;
                document.getElementById('messageModal').style.display = 'flex';
                loadMessages(); // Recarregar para atualizar status
            }
        }

        // Fechar modal
        function closeModal() {
            document.getElementById('messageModal').style.display = 'none';
        }

        // Deletar mensagem
        function deleteMessage(id) {
            if (confirm('Tem certeza que deseja excluir esta mensagem?')) {
                adminFunctions.deleteMessage(id);
                adminFunctions.showNotification('Mensagem excluída com sucesso!', 'success');
                loadMessages();
            }
        }

        // Marcar todas como lidas
        function markAllAsRead() {
            const messages = adminFunctions.loadMessages();
            messages.forEach(msg => {
                if (!msg.read) {
                    adminFunctions.markAsRead(msg.id);
                }
            });
            adminFunctions.showNotification('Todas as mensagens foram marcadas como lidas!', 'success');
            loadMessages();
        }

        // Inicializar
        loadMessages();
    </script>
</body>
</html>

